# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```
## Архитектура приложения
Архитектура приложения разработана в парадигме MVP.\
Выделены слои:
- Слой данных -данные, с  которыми работает приложение, 
- Слой представления - отвечает за отоброжение;
- Слой презентера - организовывает связь между данными и отображением;
## Данные и типы данных используемые в приложении 

Карточка товара

```
interface ICard {
  id: string;
  description: string;
  image: string;
  title: string;
  category: string;
  price: number;
}
```

Пользователь
```
interface IUser {
  email: string;
  phone: string;
  payment: string;
  address: string;
}
```

Интерфейс для работы с данными карточек

```
interface ICardData {
  cards: ICard[];
  preview: string | null;
  getBasketItems(): void;
  getLengthBasket(): number;
  getBasketTotal(): number;
  updateCard(card: TModelCard, value: boolean): void;
  updateCardId(cardId: string): void;
  getCard(cardId: string): TModelCard;
  indexCard(card: TModelCard): string;
  getIdSelectedCard(): void;
  clearBasket(cardId: string[]): void;
}
```

Работа с данными Пользователя: сохранение, получение, валидация
```
interface IUserData {
  getUserInfo(field: keyof IUser): void;
  setInputField(field: keyof IUser, value: string): void;
  validForm(data: string[]): boolean;
  validateOrder(): boolean;
}
```

Модель карточки товаров для работы в приложении
```
type TModelCard = ICard & {selected: boolean}
```

Id карточки

```
type ICardId = Pick<ICard, 'id' >
```
Данные пользователя, используемые в форме ввода контактов

```
type IFormContact = Pick<IUser, 'email' | 'phone'>
```
Данные пользователя,  используемые в форме ввода данных оплаты и доставки

```
type IOrderForm = Pick<IUser, 'payment' | 'address'>
```

Массив для отправки данных пользователя на сервер
```
interface IOrder extends IFormContact, IOrderForm, IBasketTotal {
  items: string[]
}
```

```
export interface IOrderForms extends IOrderForm {
  items: string[];
}
```
ошибки валидации
```
type FormErrors = Partial<Record<keyof IOrderForms, string>>;
```

Получает общую сумму заказа
```
interface IBasketTotal {
  total: number
}
```
получение результата промиса при отправке post запроса 
```
interface IOrderResult {
  id: string;
  total: number
}
```

## Базовый код
#### Класс Api 
Предоставляет инструменты для работы с сервером.
В конструкторе принимает базовый URL для запроса на сервер и опциональный объект с заголовками запросов.
Реализует методы 
- `get` - выполняет `GET` запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер,
- `post` - принимает объект с данными, которые будут переданы в `JSON` тела запроса и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняет `POST` запрос, но может быть переопределен третьим параметром при вызове.

#### Класс Component
Необходим для работы с разметкой. Является  дженериком и родительских для всех компонентов слоя представления.
В конструкторе принимает контейнер `container: HTMLElement` - контейнер, с которым будет построена работа.
Реализует методы:
 - `toggleClass` - Переключения класса;
 - `setText` - Установка текстового содержимого;
 - `setDisabled` -Меняет статус блокировки;
 - `setHidden` и `setVisible` - Скрывает и показывает элемент разметки;
 - `setImage` Устанавливает изображение с алтернативным текстом;
 - `render` - Возвращает корневой DOM-элемент.

#### Класс EventEmitter
Реализует паттерн «Наблюдатель» и позволяет подписываться на события и уведомлять подписчиков
о наступлении события.
Класс имеет методы 
- `on` — для подписки на событие,
- `off` — отписки от события,  
- `emit` — уведомления подписчиков о наступлении события.
Дополнительно реализованы методы  
- `onAll` — для подписки на все события
- `offAll`  —  и сброса всех подписчиков.

Интересным дополнением является метод  `trigger`, генерирующий заданное событие с заданными
аргументами. Это позволяет передавать его в качестве обработчика события в другие классы. Эти
классы будут генерировать события, не будучи при этом напрямую зависимыми от класса  `EventEmitter`.

## Слой данных (бизнес-логика)
 ### Класс CardsData 
 Класс отвечает за хранение карточек товаров.\
 Конструктор класса принимает инстант Брокера событий ??????\
 В полях класса хранятся данные:
 - _cards: ICard[] Массив объектов карточек;
 - _preview: string | null id карточки, выбранной для загрузки в модальное окно;
 - events: IEvents - экземпляр класса `EventEmitter`, для генерации событий при изменении данных;

Методы для взаимодействия с этими данными:
 - addCard(card: ICard): void Добавляет карточку в конец массива и вызывает событие изменение массива;
 - getBasketItems(): void - возвращает выбранные к покупке карточки;
 - getLengthBasket(): number - возвращает количество выбранных к покупке карточек товаров;
 - getBasketTotal(): number - возвращает общую сумму покупки;
 - deleteCard(): TModelCard[] - удаляет карточку из массива выбранных карточек;
 - updateCard(card: TModelCard, value: boolean): void - обновляет данные карточки в массиве;
 - getCard(cardId: string): TModelCard; возвращает карточку по ее id;
 - indexCard(card: TModelCard): string - возвращает порядковый номер выбраннойкартоки для вывода в корзину;
 - getIdSelectedCard(): void - возвращает id выбраных к покупке товаров;
- clearBasket(cardId: string[]): void; - очищает корзину.

 ### Класс UserData
 Класс отвечает за хранение и логику работы с данными пользователя.
 Конструктор класса принимает инстант Брокера событий.
 В полях класса хранятся данные:
	- order: IForms; - ордер повторяет данные для отправки сервер, содержит

  Методы для взаимодействия с этими данными:
   - getUserInfo(field: keyof IUser) - возвращает данные, указанные пользователем;
   - setField(field: keyof IUser, value: string): void;
   - validateOrder(): boolean;


## Компоненты представления
### Класс Page 
Класс отвечает за отображение главной страницы. 
В полях класса содержатся элементы: содержимого страницы и корзины.В конструкторе передается элемент body. Так же принимает экземпляр `EventEmitter` для иницилизации событий.\
Реализованы сеттеры обновления индекса корзины и блокировки прокрутки страницы.

### Класс Card 
Класс отвечает за отображение карточек на странице.\
В конструкторе передается DOM-элемент template, позволяя при необходимости формировать карточки разных вариантов верстки. Так же принимает экземпляр `EventEmitter` для иницилизации событий.\
В классе устанавливаются слушатели событий на интерактивные элемнты, с которыми может взаимодействовать пользователь, в результате которого генерируется событие. Метод render наследует от базового класса component.\
Поля класса содержат элементы разметки карточек.

Методы:
- через сеттеры  заполняет поля каждой из карточек и сохраняет id каждой;
- геттер id - возвращает уникальный id карточки.

### Класс CardsContainer
Отвечает за отображение блока карточек на главной странице. В конструкторепринимает контейнер в котором размещаются карточки.Метод render наследует от базового класса component.

### Класс modal
Реализует модальное окно. Метод render наследует от базового класса component. Предоставляет Методы `open` и `close` для управления открытием и закрытием модального окна. Устанавливает слушатели для закрытия модального окна (крестик, ESC, оверлей)
- ` constructor(container: HTMLElement, protected events: IEvents)` Конструктор принимает объект содержимого модального окна  и `EventEmitter`, для генерации событий при изменениях;

Поля класса:
- modal: HTMLElement - разметка модального окна;
- events: IEvents - Брокер событий;
- _content: HTMLElement; - контент модального окна;

### Класс Basket 
Конструктор класса принимает темплейт содержимого корзины и `EventEmitter`, для генерации событий при изменениях и самбите; Устанавливает слушатели событий корзины. В полях класса хранится массив карточек, находящихся в корзине, общую сумму покупки, и кнопки удаления и оформления заказа:
 - _list: HTMLElement;
 - _price: HTMLElement;
 - _button: HTMLElement;
Реализует сеттеры для обновления списка карточек и суммы покупки.

### Класс Form
Конструктор класса принимает темплейт содержимого формы и `EventEmitter`, для генерации событий при изменениях; Устанавливает слушатели событий на вводимое значение в инпут и кнопки. В полях класса хранит кнопки  и массив ошибок валидации. Резализует сеттеры значения валидности и вывода ошибки.
предоставляетя метод `onInputChange` для генерации события изменения вводимого значения. Расширяет родительский метод `render`, заполняет поля значениями из `error`. Реализует сеттеры для изменения отображения.

### Класс Success
Конструктор класса принимает темплейт успешного оформления заказа и `EventEmitter`, для генерации событий при изменениях. Устанавливает слушатель на кнопку "за новыми покупками". Реализует сеттер для отражения общей суммы покупки.

## Интерфейс API-клиента
### Класс AppApi
Наследует класс Api. Принимает в конструктор базовый адрес для запроса на сервер и CDN для получения картинки. Предоставляет методы для взаимодействия с бекендом сервиса:
- getCardItem(id: string): Promise<ICard> - запрос карточки по id;
- getCardList(): Promise<ICard[]> - получение списка карточек;
- order(order: IOrder): Promise<IOrderResult> - отправка даннных заказа на сервер;

## Брокер событий 
### Взаимодействие компонентов
Код, описывающий взаимодействовие представления и данных между собой находится в файле index.ts и выполняет роль презентера.
Взаимодействие осуществляется за счет генерируемых событий и их обработчиков.
Сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.\
События изменения данных:
- `cards:changed` - изменение массива карточек;
- `card:selected` - изменение массива отложенных в корзину карточек;
- `user:changed` - изменение данных пользователя;
- `initialData:loaded` - загрузка данных с сервера;

События возникающие при взаимодействии пользователя с интерфейсом:
- `mousedown` - наведение кусора мыши для закрытия модального окна;
- `card:openClick` - клик по карточке, для открытия ее в модальном окне;
- `card:addToBasket` - клик по кнопке отложить/удалить карточку в/из корзины;
- `card:delete` - удаление карточки из корзины;
- `modal:open` - открытие модального окнаж
- `modal:close` -  закрытие модального окна;
- `basket:open` - открытие корзины;
- `basket:changes` - изменениекорзины;
- `card:delete` - удаление карточки из корзины;
- `success:close` - закрытие окна на кнопку за новыми покупками;
- `order:submit` / `contacts:submit` - самбит на кнопку формы ордер и контактов;
- `button:paymentChanged` - клик по кнопке выбора способа оплаты;
- `order:open` - открыть форму ордер, для ввода адреса и способа оплаты (оформить заказ из корзины);
- `form:submit` - отправка  заказа;
- `formErrors:change` - ошибки при валидации формы, событие сообщающее необходимость валидации данных формы;
- `/^order\..*:change/` - слушатель инпута из формы ордер;
- `/^contacts..*:change` - слушатель инпута из формы контактных данных пользователя;
- `contacts:submit` / `order:submit` - открыть форму с контактными данными/ форму ордер, для ввода адреса и способа оплаты (оформить заказ из корзины);




